{% extends 'social/base.html' %}

{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة بطاقات الذاكرة المميزة</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 600px;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .info-box {
            text-align: center;
        }
        
        .game-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
            perspective: 1000px;
        }
        
        .card {
            width: 120px;
            height: 160px;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
        }
        
        .card-front {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            transform: rotateY(180deg);
        }
        
        .card-back {
            background: linear-gradient(45deg, #0f2027, #203a43, #2c5364);
            color: white;
        }
        
        .card.flipped {
            transform: rotateY(180deg);
        }
        
        .card.matched {
            transform: rotateY(180deg);
            box-shadow: 0 0 15px gold;
            cursor: default;
        }
        
        .card.matched .card-front {
            background: linear-gradient(45deg, #4CAF50, #2E7D32);
        }
        
        .controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
        }
        
        button {
            padding: 12px 25px;
            font-size: 16px;
            background: linear-gradient(45deg, #4e54c8, #8f94fb);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .difficulty {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        
        .difficulty button {
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .timer-animation {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .timer-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            width: 100%;
            transition: width 1s linear;
        }
        
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        
        @media (max-width: 600px) {
            .game-container {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .card {
                width: 80px;
                height: 120px;
                font-size: 30px;
            }
        }
    </style>
</head>
<body>
    <h1>لعبة بطاقات الذاكرة المميزة</h1>
    
    <div class="game-info">
        <div class="info-box">
            <div>الوقت</div>
            <div id="timer">00:00</div>
            <div class="timer-animation">
                <div class="timer-progress" id="timer-progress"></div>
            </div>
        </div>
        <div class="info-box">
            <div>المحاولات</div>
            <div id="moves">0</div>
        </div>
        <div class="info-box">
            <div>الأزواج</div>
            <div id="pairs">0 / 8</div>
        </div>
    </div>
    
    <div class="game-container" id="game-board"></div>
    
    <div class="difficulty">
        <button id="easy-btn">سهل (4x3)</button>
        <button id="medium-btn">متوسط (4x4)</button>
        <button id="hard-btn">صعب (6x4)</button>
    </div>
    
    <div class="controls">
        <button id="restart-btn">إعادة البدء</button>
        <button id="hint-btn">مساعدة</button>
    </div>
    
    <div class="celebration" id="celebration"></div>
    
    <script>
        // عناصر اللعبة
        const gameBoard = document.getElementById('game-board');
        const timerDisplay = document.getElementById('timer');
        const movesDisplay = document.getElementById('moves');
        const pairsDisplay = document.getElementById('pairs');
        const timerProgress = document.getElementById('timer-progress');
        const restartBtn = document.getElementById('restart-btn');
        const hintBtn = document.getElementById('hint-btn');
        const easyBtn = document.getElementById('easy-btn');
        const mediumBtn = document.getElementById('medium-btn');
        const hardBtn = document.getElementById('hard-btn');
        const celebration = document.getElementById('celebration');
        
        // متغيرات اللعبة
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let moves = 0;
        let seconds = 0;
        let timer;
        let gameStarted = false;
        let totalPairs = 8;
        let boardSize = 'medium';
        let hintAvailable = true;
        
        // الرموز المستخدمة في البطاقات
        const symbols = ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', 
                        '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦'];
        
        // تهيئة اللعبة
        function initGame() {
            // إعداد حجم اللوحة حسب الصعوبة
            switch(boardSize) {
                case 'easy':
                    totalPairs = 6;
                    gameBoard.style.gridTemplateColumns = 'repeat(3, 1fr)';
                    break;
                case 'medium':
                    totalPairs = 8;
                    gameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
                    break;
                case 'hard':
                    totalPairs = 12;
                    gameBoard.style.gridTemplateColumns = 'repeat(4, 1fr)';
                    break;
            }
            
            // إعادة تعيين المتغيرات
            gameBoard.innerHTML = '';
            flippedCards = [];
            matchedPairs = 0;
            moves = 0;
            seconds = 0;
            gameStarted = false;
            hintAvailable = true;
            
            // تحديث العرض
            movesDisplay.textContent = moves;
            pairsDisplay.textContent = `0 / ${totalPairs}`;
            timerDisplay.textContent = '00:00';
            timerProgress.style.width = '100%';
            
            // إنشاء البطاقات
            createCards();
        }
        
        // إنشاء البطاقات
        function createCards() {
            cards = [];
            
            // اختيار الرموز حسب عدد الأزواج
            const selectedSymbols = symbols.slice(0, totalPairs);
            const cardSymbols = [...selectedSymbols, ...selectedSymbols];
            
            // خلط البطاقات
            for (let i = cardSymbols.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardSymbols[i], cardSymbols[j]] = [cardSymbols[j], cardSymbols[i]];
            }
            
            // إنشاء عناصر البطاقات
            cardSymbols.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                
                const cardFront = document.createElement('div');
                cardFront.className = 'card-face card-front';
                cardFront.textContent = symbol;
                
                const cardBack = document.createElement('div');
                cardBack.className = 'card-face card-back';
                
                card.appendChild(cardFront);
                card.appendChild(cardBack);
                card.addEventListener('click', flipCard);
                
                gameBoard.appendChild(card);
                cards.push(card);
            });
        }
        
        // قلب البطاقة
        function flipCard() {
            if (!gameStarted) {
                startTimer();
                gameStarted = true;
            }
            
            const selectedCard = this;
            
            // لا تسمح بقلب بطاقة مقلوبة أو متطابقة
            if (flippedCards.includes(selectedCard) || selectedCard.classList.contains('matched')) {
                return;
            }
            
            // لا تسمح بقلب أكثر من بطاقتين
            if (flippedCards.length >= 2) {
                return;
            }
            
            // قلب البطاقة
            selectedCard.classList.add('flipped');
            flippedCards.push(selectedCard);
            
            // التحقق من التطابق عند قلب بطاقتين
            if (flippedCards.length === 2) {
                moves++;
                movesDisplay.textContent = moves;
                
                const [firstCard, secondCard] = flippedCards;
                
                if (firstCard.dataset.symbol === secondCard.dataset.symbol) {
                    // تطابق ناجح
                    firstCard.classList.add('matched');
                    secondCard.classList.add('matched');
                    matchedPairs++;
                    pairsDisplay.textContent = `${matchedPairs} / ${totalPairs}`;
                    flippedCards = [];
                    
                    // تشغيل تأثير النجاح
                    playSuccessEffect(firstCard);
                    
                    // التحقق من الفوز
                    if (matchedPairs === totalPairs) {
                        clearInterval(timer);
                        setTimeout(() => {
                            celebrate();
                            alert(`مبروك! لقد فزت بـ ${moves} محاولة وفي ${formatTime(seconds)}!`);
                        }, 500);
                    }
                } else {
                    // عدم تطابق
                    setTimeout(() => {
                        firstCard.classList.remove('flipped');
                        secondCard.classList.remove('flipped');
                        flippedCards = [];
                    }, 1000);
                }
            }
        }
        
        // بدء المؤقت
        function startTimer() {
            clearInterval(timer);
            seconds = 0;
            updateTimer();
            timer = setInterval(() => {
                seconds++;
                updateTimer();
                
                // تحديث شريط التقدم
                const progressPercentage = 100 - Math.min(100, (seconds / 120) * 100);
                timerProgress.style.width = `${progressPercentage}%`;
                
                // تغيير اللون عندما ينفد الوقت
                if (progressPercentage < 20) {
                    timerProgress.style.background = 'linear-gradient(90deg, #f44336, #ff9800)';
                }
            }, 1000);
        }
        
        // تحديث المؤقت
        function updateTimer() {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // تنسيق الوقت
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes} دقيقة و ${seconds} ثانية`;
        }
        
        // تأثير النجاح عند التطابق
        function playSuccessEffect(card) {
            const rect = card.getBoundingClientRect();
            const confetti = document.createElement('div');
            confetti.style.position = 'fixed';
            confetti.style.left = `${rect.left + rect.width / 2}px`;
            confetti.style.top = `${rect.top + rect.height / 2}px`;
            confetti.style.width = '10px';
            confetti.style.height = '10px';
            confetti.style.backgroundColor = 'gold';
            confetti.style.borderRadius = '50%';
            confetti.style.zIndex = '50';
            document.body.appendChild(confetti);
            
            // تحريك التأثير
            const animation = confetti.animate([
                { transform: 'scale(1)', opacity: 1 },
                { transform: 'scale(3)', opacity: 0 }
            ], {
                duration: 1000,
                easing: 'ease-out'
            });
            
            animation.onfinish = () => {
                confetti.remove();
            };
        }
        
        // تأثير الفوز
        function celebrate() {
            celebration.style.display = 'block';
            
            // إنشاء عناصر الاحتفال
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = `${Math.random() * 10 + 5}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                particle.style.borderRadius = '50%';
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                celebration.appendChild(particle);
                
                // تحريك الجسيمات
                const animation = particle.animate([
                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },
                    { transform: `translate(${Math.random() * 200 - 100}px, ${Math.random() * 200 - 100}px) scale(0)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 1000,
                    easing: 'ease-out'
                });
                
                animation.onfinish = () => {
                    particle.remove();
                };
            }
            
            setTimeout(() => {
                celebration.style.display = 'none';
                celebration.innerHTML = '';
            }, 3000);
        }
        
        // ميزة المساعدة
        function giveHint() {
            if (!hintAvailable || flippedCards.length > 0 || matchedPairs === totalPairs) return;
            
            hintAvailable = false;
            hintBtn.disabled = true;
            
            // العثور على بطاقات غير متطابقة وغير مقلوبة
            const unflippedCards = Array.from(cards).filter(card => 
                !card.classList.contains('matched') && 
                !card.classList.contains('flipped')
            );
            
            if (unflippedCards.length < 2) return;
            
            // العثور على زوج متطابق
            const cardMap = {};
            let hintCards = [];
            
            for (const card of unflippedCards) {
                const symbol = card.dataset.symbol;
                if (cardMap[symbol]) {
                    hintCards = [cardMap[symbol], card];
                    break;
                }
                cardMap[symbol] = card;
            }
            
            if (hintCards.length === 2) {
                // إظهار الإشارة
                hintCards.forEach(card => {
                    card.style.boxShadow = '0 0 15px yellow';
                });
                
                setTimeout(() => {
                    hintCards.forEach(card => {
                        card.style.boxShadow = '';
                    });
                }, 2000);
            }
        }
        
        // إعداد الأحداث
        restartBtn.addEventListener('click', initGame);
        hintBtn.addEventListener('click', giveHint);
        easyBtn.addEventListener('click', () => {
            boardSize = 'easy';
            initGame();
        });
        mediumBtn.addEventListener('click', () => {
            boardSize = 'medium';
            initGame();
        });
        hardBtn.addEventListener('click', () => {
            boardSize = 'hard';
            initGame();
        });
        
        // بدء اللعبة لأول مرة
        initGame();
    </script>
{% endblock %}