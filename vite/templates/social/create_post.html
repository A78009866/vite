{% extends 'social/base.html' %}
{% load static %}
{% block content %}
<style>
    /*
        Styling for the create post page, with a dark theme.
        This ensures a consistent and aesthetically pleasing user experience.
    */
    .dark-create-post {
        background-color: #121212;
        color: #e0e0e0;
        min-height: 100vh;
        padding-top: 30px;
    }
    .dark-post-card {
        background-color: #1e1e1e;
        border-color: #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .form-control-dark {
        background-color: #2d2d2d !important;
        border-color: #444 !important;
        color: #e0e0e0 !important;
    }
    .form-control-dark::placeholder {
        color: #9e9e9e !important;
    }
    .btn-glass {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.2);
    }
    .btn-outline-danger {
        color: #dc3545;
        border-color: #dc3545;
    }
    .btn-outline-danger:hover {
        background-color: #dc3545;
        color: #fff;
    }
    .btn-primary {
        background-color: #4a6bff;
        border-color: #4a6bff;
    }
    .btn-primary:hover {
        background-color: #3a5bef;
        border-color: #3a5bef;
    }
    #media-preview {
        border: 1px dashed #444;
        background-color: #252525;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        min-height: 80px;
        margin-top: 15px;
    }
    .preview-title {
        color: #9e9e9e;
        margin-bottom: 10px;
        font-size: 0.9rem;
    }
    .preview-image, .preview-video {
        max-width: 100%;
        height: auto;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    .card-title {
        color: #ffffff;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .icon-white {
        color: #fff !important;
    }

    /* Animation for the recording status dot */
    .blink {
        animation: blink-animation 1s steps(5, start) infinite;
        -webkit-animation: blink-animation 1s steps(5, start) infinite;
    }
    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }
    @-webkit-keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }
</style>

<div class="dark-create-post">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="dark-post-card card mb-4">
                    <div class="card-body">
                        <form method="POST" action="{% url 'create_post' %}" enctype="multipart/form-data" id="createPostForm">
                            {% csrf_token %}
                            <h5 class="card-title"><i class="fas fa-plus-circle me-2 icon-white"></i>إنشاء منشور جديد</h5>

                            <div class="form-group mb-4">
                                <textarea class="form-control form-control-dark" name="content" rows="5" placeholder="بماذا تفكر؟"></textarea>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <!-- Upload voice note button -->
                                    <label for="id_voice_note" class="btn btn-sm btn-glass me-2" title="رفع مقطع صوتي">
                                        <i class="fas fa-file-audio icon-white"></i>
                                    </label>
                                    <input type="file" name="voice_note" accept="audio/*" id="id_voice_note" style="display: none;">

                                    <!-- Record audio buttons -->
                                    <button type="button" id="record-btn" class="btn btn-sm btn-glass me-2" title="تسجيل صوت">
                                        <i class="fas fa-microphone icon-white"></i>
                                    </button>
                                    <button type="button" id="stop-record-btn" class="btn btn-sm btn-danger d-none" title="إيقاف التسجيل">
                                        <i class="fas fa-stop-circle icon-white"></i>
                                    </button>
                                    <span id="recording-status" class="text-muted d-none">يتم التسجيل... <i class="fas fa-dot-circle text-danger blink"></i></span>

                                    <!-- Upload image button -->
                                    <label for="id_image" class="btn btn-sm btn-glass me-2" title="رفع صورة">
                                        <i class="fas fa-image icon-white"></i>
                                    </label>
                                    <input type="file" name="image" accept="image/*" id="id_image" style="display: none;">

                                    <!-- Upload video button -->
                                    <label for="id_video" class="btn btn-sm btn-glass" title="رفع فيديو">
                                        <i class="fas fa-video icon-white"></i>
                                    </label>
                                    <input type="file" name="video" accept="video/*" id="id_video" style="display: none;">
                                </div>
                                <button type="submit" class="btn btn-primary" id="post-submit-btn">نشر</button>
                            </div>

                            <!-- Media preview section -->
                            <div id="media-preview" class="d-none">
                                <p class="preview-title" id="preview-text">لا يوجد وسائط مختارة</p>
                                <img id="image-preview" src="#" alt="معاينة الصورة" class="preview-image d-none">
                                <video id="video-preview" controls class="preview-video d-none"></video>
                                <div id="audio-preview-container" class="d-none">
                                    <audio controls class="w-100"></audio>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="clear-uploaded-audio-btn"><i class="fas fa-trash me-1 icon-white"></i> إزالة المقطع الصوتي</button>
                                </div>
                            </div>

                            <!-- Recorded audio preview section -->
                            <div id="recorded-audio-preview" class="mt-3 d-none">
                                <audio controls class="w-100"></audio>
                                <button type="button" class="btn btn-sm btn-danger mt-2" id="clear-recording-btn"><i class="fas fa-trash me-1 icon-white"></i> حذف المقطع الصوتي</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all the relevant elements from the DOM
    const recordBtn = document.getElementById('record-btn');
    const stopRecordBtn = document.getElementById('stop-record-btn');
    const recordingStatus = document.getElementById('recording-status');
    const clearRecordingBtn = document.getElementById('clear-recording-btn');
    const recordedAudioPreview = document.getElementById('recorded-audio-preview');
    const recordedAudioPlayer = recordedAudioPreview.querySelector('audio');
    const createPostForm = document.getElementById('createPostForm');
    const voiceNoteInput = document.getElementById('id_voice_note');
    const imageInput = document.getElementById('id_image');
    const videoInput = document.getElementById('id_video');
    const mediaPreviewDiv = document.getElementById('media-preview');
    const previewText = document.getElementById('preview-text');
    const imagePreview = document.getElementById('image-preview');
    const videoPreview = document.getElementById('video-preview');
    const audioPreviewContainer = document.getElementById('audio-preview-container');
    const uploadedAudioPlayer = audioPreviewContainer.querySelector('audio');
    const clearUploadedAudioBtn = document.getElementById('clear-uploaded-audio-btn');

    let mediaRecorder;
    let audioChunks = [];
    let recordedBlob;

    // A function to disable other file inputs when one is selected
    function disableOtherInputs(activeInput) {
        imageInput.disabled = (activeInput !== imageInput && activeInput !== null);
        videoInput.disabled = (activeInput !== videoInput && activeInput !== null);
        voiceNoteInput.disabled = (activeInput !== voiceNoteInput && activeInput !== null);
        recordBtn.disabled = (activeInput !== null);
    }

    // A function to toggle the visibility of the media preview section
    function toggleMediaPreview(hasMedia) {
        if (hasMedia) {
            mediaPreviewDiv.classList.remove('d-none');
            previewText.classList.add('d-none');
        } else {
            mediaPreviewDiv.classList.add('d-none');
            previewText.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            imagePreview.src = '#';
            videoPreview.classList.add('d-none');
            videoPreview.src = '#';
            audioPreviewContainer.classList.add('d-none');
            uploadedAudioPlayer.src = '#';
        }
    }

    // Event listener for image input change
    imageInput.addEventListener('change', function() {
        const file = this.files.length > 0 ? this.files[0] : null;
        if (file) {
            imagePreview.src = URL.createObjectURL(file);
            imagePreview.classList.remove('d-none');
            videoPreview.classList.add('d-none');
            audioPreviewContainer.classList.add('d-none');
            recordedAudioPreview.classList.add('d-none');
            toggleMediaPreview(true);
            disableOtherInputs(this);
        } else {
            imagePreview.classList.add('d-none');
            imagePreview.src = '#';
            // Check if other media is selected before hiding the preview
            if (!videoInput.files.length && !voiceNoteInput.files.length && !recordedBlob) {
                toggleMediaPreview(false);
                disableOtherInputs(null);
            }
        }
    });

    // Event listener for video input change
    videoInput.addEventListener('change', function() {
        const file = this.files.length > 0 ? this.files[0] : null;
        if (file) {
            videoPreview.src = URL.createObjectURL(file);
            videoPreview.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            audioPreviewContainer.classList.add('d-none');
            recordedAudioPreview.classList.add('d-none');
            toggleMediaPreview(true);
            disableOtherInputs(this);
        } else {
            videoPreview.classList.add('d-none');
            videoPreview.src = '#';
            if (!imageInput.files.length && !voiceNoteInput.files.length && !recordedBlob) {
                toggleMediaPreview(false);
                disableOtherInputs(null);
            }
        }
    });

    // Event listener for uploaded voice note input change
    voiceNoteInput.addEventListener('change', function() {
        const file = this.files.length > 0 ? this.files[0] : null;
        if (file) {
            uploadedAudioPlayer.src = URL.createObjectURL(file);
            audioPreviewContainer.classList.remove('d-none');
            imagePreview.classList.add('d-none');
            videoPreview.classList.add('d-none');
            recordedAudioPreview.classList.add('d-none');
            toggleMediaPreview(true);
            disableOtherInputs(this);
        } else {
            audioPreviewContainer.classList.add('d-none');
            uploadedAudioPlayer.src = '#';
            if (!imageInput.files.length && !videoInput.files.length && !recordedBlob) {
                toggleMediaPreview(false);
                disableOtherInputs(null);
            }
        }
    });

    // Event listener for the "Remove" button for the uploaded audio
    clearUploadedAudioBtn.addEventListener('click', function() {
        voiceNoteInput.value = '';
        audioPreviewContainer.classList.add('d-none');
        uploadedAudioPlayer.src = '#';
        if (!imageInput.files.length && !videoInput.files.length && !recordedBlob) {
            toggleMediaPreview(false);
        }
        disableOtherInputs(null);
    });

    // Event listener for the "Record" button
    recordBtn.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            recordedBlob = null;
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                recordedBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                const audioUrl = URL.createObjectURL(recordedBlob);
                recordedAudioPlayer.src = audioUrl;
                recordedAudioPreview.classList.remove('d-none');
                
                stream.getTracks().forEach(track => track.stop());
                disableOtherInputs(null);
            };

            mediaRecorder.start();
            recordBtn.classList.add('d-none');
            stopRecordBtn.classList.remove('d-none');
            recordingStatus.classList.remove('d-none');
            recordedAudioPreview.classList.add('d-none');

            // Hide other media previews when recording starts
            imagePreview.classList.add('d-none');
            videoPreview.classList.add('d-none');
            audioPreviewContainer.classList.add('d-none');
            toggleMediaPreview(true);
            previewText.textContent = 'يتم التسجيل...';
            disableOtherInputs(recordBtn);

        } catch (err) {
            console.error('Error accessing microphone:', err);
            alert('تعذر الوصول إلى الميكروفون. يرجى التأكد من منحه الإذن والمحاولة مرة أخرى.');
        }
    });

    // Event listener for the "Stop Recording" button
    stopRecordBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            recordBtn.classList.remove('d-none');
            stopRecordBtn.classList.add('d-none');
            recordingStatus.classList.add('d-none');
            previewText.classList.add('d-none');
        }
    });

    // Event listener for the "Delete Recording" button
    clearRecordingBtn.addEventListener('click', () => {
        recordedBlob = null;
        recordedAudioPreview.classList.add('d-none');
        recordedAudioPlayer.src = '';
        // Update media preview state
        if (!imageInput.files.length && !videoInput.files.length && !voiceNoteInput.files.length) {
            toggleMediaPreview(false);
        }
        disableOtherInputs(null);
    });

    // Event listener for form submission
    createPostForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const formData = new FormData(this);
        if (recordedBlob) {
            // Append the recorded audio as a file to the form data
            formData.append('voice_note', recordedBlob, 'recorded_audio.mp3');
        }

        fetch(this.action, {
            method: this.method,
            body: formData
        })
        .then(response => {
            if (response.ok) {
                window.location.href = '{% url "home" %}';
            } else {
                alert('حدث خطأ أثناء نشر المنشور.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('حدث خطأ في الشبكة.');
        });
    });
});
</script>

{% endblock %}
