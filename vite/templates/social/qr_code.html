{% extends 'social/base.html' %}
{% load static %}
<style>
  /* أنماط زر الماسح */
#qrScannerBtn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
}

/* أنماط واجهة الماسح */
#scannerContainer {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#scanFrame {
    box-shadow: 0 0 0 100vmax rgba(0, 0, 0, 0.7);
}

#switchCamera {
    display: none; /* سيتم إظهاره فقط إذا كانت هناك أكثر من كاميرا */
}

@media (max-width: 768px) {
    #qrScannerBtn span {
        display: none;
    }
}
</style>
{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 text-center">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3>كود QR الخاص بي</h3>
                </div>
                <div class="card-body">
                    {% if profile_user.qr_code %}
                        <img src="{{ profile_user.qr_code }}" class="img-fluid mb-3" alt="QR Code">
                        <p class="text-muted">مسح هذا الكود للوصول إلى بروفايلي</p>
                    {% else %}
                        <p class="text-danger">لا يوجد كود QR متوفر</p>
                    {% endif %}
                    
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <a href="{% url 'profile' profile_user.username %}" class="btn btn-outline-primary">
                            العودة إلى البروفايل
                        </a>
                        <button onclick="window.print()" class="btn btn-primary">
                            <i class="fas fa-print"></i> طباعة الكود
                        </button>
                        <!-- زر ماسح QR مع أيقونة و نص -->
        <button type="button" class="btn btn-info ms-2 btn-animate" id="qrScannerBtn">
            <i class="fas fa-qrcode"></i> ماسح الكود
        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const qrScannerBtn = document.getElementById('qrScannerBtn');
    const searchInput = document.querySelector('.search-bar');
    
    qrScannerBtn.addEventListener('click', function() {
        // إنشاء واجهة الماسح
        const scannerUI = `
            <div id="scannerContainer" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;background:rgba(0,0,0,0.9);display:flex;flex-direction:column;align-items:center;justify-content:center;">
                <div style="position:relative;width:80%;max-width:400px;">
                    <video id="qrScanner" style="width:100%;border-radius:10px;"></video>
                    <div id="scanFrame" style="position:absolute;top:0;left:0;width:100%;height:100%;border:2px solid rgba(0,255,0,0.5);border-radius:10px;pointer-events:none;"></div>
                    <div id="scanLine" style="position:absolute;top:20%;width:100%;height:3px;background:#00ff00;box-shadow:0 0 10px #00ff00;animation:scanAnimation 2s infinite linear;"></div>
                </div>
                <p style="color:white;margin-top:20px;font-size:1.1rem;">ضع كود QR داخل الإطار</p>
                <button id="closeScanner" class="btn btn-danger mt-3">إغلاق الماسح</button>
                <button id="switchCamera" class="btn btn-secondary mt-2">تبديل الكاميرا</button>
                <style>
                    @keyframes scanAnimation {
                        0% { top: 20%; }
                        100% { top: 80%; }
                    }
                </style>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', scannerUI);
        
        const videoElement = document.getElementById('qrScanner');
        const closeBtn = document.getElementById('closeScanner');
        const switchBtn = document.getElementById('switchCamera');
        let currentCameraIndex = 0;
        let cameras = [];
        let scanner = new Instascan.Scanner({ video: videoElement, mirror: false });
        
        // دالة لبدء الكاميرا المحددة
        function startCamera(index) {
            if (cameras.length > 0) {
                scanner.stop();
                scanner.start(cameras[index]);
                // جعل الكاميرا الخلفية هي الافتراضية إذا كانت متوفرة
                if (cameras.length > 1) {
                    const rearCameraIndex = cameras.findIndex(cam => cam.name.includes('back') || cam.name.includes('rear'));
                    if (rearCameraIndex !== -1 && index !== rearCameraIndex) {
                        currentCameraIndex = rearCameraIndex;
                        startCamera(rearCameraIndex);
                    }
                }
            }
        }
        
        // البحث عن الكاميرات وبدء التشغيل
        Instascan.Camera.getCameras()
            .then(availableCameras => {
                cameras = availableCameras;
                if (cameras.length > 0) {
                    startCamera(currentCameraIndex);
                } else {
                    alert('لم يتم العثور على كاميرا!');
                    closeScanner();
                }
            })
            .catch(err => {
                console.error('حدث خطأ:', err);
                alert('لا يمكن الوصول إلى الكاميرا');
                closeScanner();
            });
        
        // عند مسح الكود
        scanner.addListener('scan', content => {
            const username = content.split('/').pop();
            searchInput.value = username;
            document.querySelector('form[action="{% url 'search_users' %}"]').submit();
            closeScanner();
        });
        
        // تبديل الكاميرا
        switchBtn.addEventListener('click', () => {
            currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
            startCamera(currentCameraIndex);
        });
        
        // إغلاق الماسح
        function closeScanner() {
            scanner.stop();
            const container = document.getElementById('scannerContainer');
            if (container) container.remove();
        }
        
        closeBtn.addEventListener('click', closeScanner);
    });
});
</script>
{% endblock %}